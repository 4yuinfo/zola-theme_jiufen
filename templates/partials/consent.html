{#
Cookie/Consent banner for Google Analytics Consent Mode v2
- Enable by setting `config.extra.google_analytics_consent = true` along with `config.extra.google_analytics_id`.
- Optional text overrides:
  - config.extra.google_analytics_consent_message
  - config.extra.google_analytics_consent_accept_text
  - config.extra.google_analytics_consent_decline_text
#}
{% if config.extra.google_analytics_id and config.extra.google_analytics_id | length > 0 and config.extra.google_analytics_consent %}
<div id="jiufen-consent" class="jiufen-consent" role="dialog" aria-live="polite" aria-modal="false" aria-label="Cookie consent" hidden>
  <div class="jiufen-consent__inner">
    <p class="jiufen-consent__text">
      {{ config.extra.google_analytics_consent_message | default(value='本網站使用 Cookie 以統計與改善體驗。您是否同意我們使用 Google Analytics 分析？') }}
    </p>
    <div class="jiufen-consent__actions">
      <button type="button" class="jiufen-consent__btn jiufen-consent__btn--primary" data-action="accept">
        {{ config.extra.google_analytics_consent_accept_text | default(value='同意') }}
      </button>
      <button type="button" class="jiufen-consent__btn" data-action="decline">
        {{ config.extra.google_analytics_consent_decline_text | default(value='不同意') }}
      </button>
    </div>
  </div>
</div>
<style>
  .jiufen-consent{position:fixed;left:0;right:0;bottom:0;z-index:9999;background:#1f2937;color:#fff;padding:12px}
  .jiufen-consent__inner{max-width:1100px;margin:0 auto;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .jiufen-consent__text{margin:0;flex:1;min-width:240px}
  .jiufen-consent__actions{display:flex;gap:8px}
  .jiufen-consent__btn{border:1px solid #9ca3af;background:transparent;color:#fff;padding:8px 14px;border-radius:6px;cursor:pointer}
  .jiufen-consent__btn--primary{background:#10b981;border-color:#10b981;color:#0b231a}
  .jiufen-consent__btn:focus{outline:2px solid #fff;outline-offset:2px}
</style>
<script data-ga-id="{{ config.extra.google_analytics_id }}" data-anonymize="{{ config.extra.google_analytics_anonymize_ip | default(value=false) }}">
(function(){
  var root = document.getElementById('jiufen-consent');
  if (!root) return;
  var stored = null;
  try { stored = localStorage.getItem('jiufen_ga_consent'); } catch(e) {}
  if (stored === 'granted' || stored === 'denied') { return; }
  root.hidden = false;
  root.querySelectorAll('button[data-action]').forEach(function(btn){
    btn.addEventListener('click', function(){
      var action = btn.getAttribute('data-action');
      var grant = action === 'accept' ? 'granted' : 'denied';
      try { localStorage.setItem('jiufen_ga_consent', grant); } catch(e) {}
      // Update GA Consent Mode
      if (typeof gtag === 'function') {
        if (grant === 'granted') {
          gtag('consent', 'update', {
            'ad_storage': 'granted',
            'analytics_storage': 'granted',
            'ad_user_data': 'granted',
            'ad_personalization': 'granted'
          });
          var id = document.currentScript.getAttribute('data-ga-id');
          var anonymize = document.currentScript.getAttribute('data-anonymize') === 'true';
          gtag('js', new Date());
          if (anonymize) { gtag('config', id, { 'anonymize_ip': true }); } else { gtag('config', id); }
        } else {
          gtag('consent', 'update', {
            'ad_storage': 'denied',
            'analytics_storage': 'denied',
            'ad_user_data': 'denied',
            'ad_personalization': 'denied'
          });
        }
      }
      root.hidden = true;
    }, { once: true });
  });
})();
</script>
{% endif %}
